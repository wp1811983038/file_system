{% extends "user/base.html" %}

{% block title %}文件管理 - 文件管理系统{% endblock %}

{% block content %}
<div class="table-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>文件列表</h2>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索文件名..." class="search-input">
        </div>
    </div>

    <table id="fileTable">
        <thead>
            <tr>
                <th width="5%">序号</th>
                <th width="20%">文件名</th>
                <th width="30%">描述</th>
                <th width="15%">提交状态</th>
                <th width="30%">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for template in templates %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ template.name }}</td>
                <td>{{ template.description or '无' }}</td>
                <td>
                    {% if template.status %}
                        <span class="status-badge status-submitted">已提交</span>
                    {% else %}
                        <span class="status-badge status-pending">未提交</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-group">
                        <!-- 模板下载按钮 -->
                        <button class="action-btn" onclick="downloadTemplate('{{ template.id }}')">
                            下载模板
                        </button>
                        
                        {% if template.status %}
                        <!-- 提交文件相关操作的下拉菜单 -->
                        <div class="dropdown">
                            <button class="action-btn dropdown-toggle">提交操作</button>
                            <div class="dropdown-content">
                                <a href="#" onclick="viewSubmission('{{ template.id }}')">查看提交</a>
                                <a href="#" onclick="downloadSubmission('{{ template.id }}')">下载提交</a>
                                <a href="#" onclick="openUploadModal('{{ template.id }}', true)">重新提交</a>
                            </div>
                        </div>
                        {% else %}
                        <button class="action-btn btn-primary" onclick="openUploadModal('{{ template.id }}', false)">
                            提交文件
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 上传文件模态框 -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">提交文件</h2>
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="hidden" id="templateId" name="template_id">
            <div class="form-group">
                <label>选择文件</label>
                <input type="file" id="userFile" name="file" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="action-btn" onclick="closeModal()">取消</button>
                <button type="submit" class="action-btn btn-primary">提交</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
.search-box {
    display: flex;
    gap: 10px;
}

.search-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 200px;
}

.search-input:focus {
    border-color: #1890ff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(24,144,255,0.2);
}
/* 操作按钮组样式 */
.action-group {
    display: flex;
    gap: 8px;
    align-items: center;
}

/* 下拉菜单样式 */
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-toggle {
    background-color: #1890ff;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.dropdown-toggle::after {
    content: '▼';
    margin-left: 5px;
    font-size: 10px;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 120px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border-radius: 4px;
    z-index: 1;
}

.dropdown-content a {
    color: #333;
    padding: 8px 12px;
    text-decoration: none;
    display: block;
    transition: background-color 0.3s;
}

.dropdown-content a:hover {
    background-color: #f5f5f5;
}

.dropdown:hover .dropdown-content {
    display: block;
}

/* 主按钮样式优化 */
.action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.action-btn.btn-primary {
    background-color: #1890ff;
    color: white;
}

.action-btn:hover {
    opacity: 0.85;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function openUploadModal(templateId, isResubmit) {
    document.getElementById('modalTitle').textContent = isResubmit ? '重新提交文件' : '提交文件';
    document.getElementById('templateId').value = templateId;
    document.getElementById('userFile').value = '';
    document.getElementById('uploadModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('uploadModal').style.display = 'none';
}

function downloadTemplate(templateId) {
    window.location.href = `/user/download_template/${templateId}`;
}

// 处理表单提交
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const templateId = document.getElementById('templateId').value;

    fetch(`/user/upload/${templateId}`, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('文件提交失败，请重试');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('文件提交失败，请重试');
    });
});

// 搜索功能
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchText = this.value.toLowerCase();
    const rows = document.querySelectorAll('#fileTable tbody tr');
    
    rows.forEach(row => {
        const fileName = row.cells[1].textContent.toLowerCase();
        const description = row.cells[2].textContent.toLowerCase();
        
        if (fileName.includes(searchText) || description.includes(searchText)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});


function viewSubmission(templateId) {
    window.open(`/user/files/${templateId}/view_submission`, '_blank');
}

function downloadSubmission(templateId) {
    window.location.href = `/user/files/${templateId}/download_submission`;
}
</script>
{% endblock %}