<!-- pages/admin/template/detail.wxml -->
<view class="container">
  <!-- 顶部信息卡片 -->
  <view class="header-card">
    <view class="template-info">
      <view class="template-name">{{templateName}}</view>
      <view class="template-meta">
        <text class="meta-item">ID: {{templateId}}</text>
        <text class="meta-item">提交情况: {{submittedCount}}/{{totalUsers}}</text>
        <text class="meta-item">提交率: {{submissionRate}}%</text>
      </view>
    </view>
    
    <view class="action-buttons">
      <button class="btn btn-back" bindtap="goBack">返回</button>
      <button class="btn btn-export" bindtap="exportData">导出数据</button>
      <button class="btn btn-download" bindtap="downloadTemplate">下载模板</button>
    </view>
  </view>

  <!-- 切换标签栏 -->
  <view class="tabs">
    <view class="tab {{activeTab === 'submitted' ? 'active' : ''}}" 
          data-tab="submitted" 
          bindtap="switchTab">
      已提交 ({{submittedCount}})
    </view>
    <view class="tab {{activeTab === 'pending' ? 'active' : ''}}" 
          data-tab="pending" 
          bindtap="switchTab">
      未提交 ({{pendingCount}})
    </view>
    <view class="tab {{activeTab === 'analytics' ? 'active' : ''}}" 
          data-tab="analytics" 
          bindtap="switchTab">
      提交率分析
    </view>
  </view>

  <!-- 已提交用户列表 -->
  <view class="tab-content" wx:if="{{activeTab === 'submitted'}}">
    <view class="search-box">
      <input type="text" class="search-input" placeholder="搜索用户名或公司名称..." bindinput="onSearchSubmitted"/>
    </view>

    <view class="table-container">
      <view class="table-header">
        <view class="th">用户名</view>
        <view class="th">公司名称</view>
        <view class="th">提交时间</view>
        <view class="th">状态</view>
        <view class="th">操作</view>
      </view>

      <view class="no-data" wx:if="{{!filteredSubmittedUsers.length}}">
        <text>暂无提交数据</text>
      </view>

      <block wx:else>
        <view class="table-row" wx:for="{{filteredSubmittedUsers}}" wx:key="user_id">
          <view class="td">{{item.username}}</view>
          <view class="td">{{item.company_name || '未设置'}}</view>
          <view class="td">{{item.submission.upload_date}}</view>
          <view class="td">
            <view class="status-badge {{getStatusClass(item.submission.status)}}">
              {{getStatusText(item.submission.status)}}
            </view>
          </view>
          <view class="td actions">
            <button class="action-btn preview-btn" 
                    bindtap="previewSubmission" 
                    data-user-id="{{item.user_id}}">
              预览
            </button>
            <button class="action-btn download-btn" 
                    bindtap="downloadSubmission" 
                    data-user-id="{{item.user_id}}">
              下载
            </button>
            <!-- 根据审批状态显示不同的审批按钮 -->
            <block wx:if="{{item.submission.status === 'submitted' || item.submission.status === 'under_review'}}">
              <button class="action-btn approve-btn" 
                      bindtap="showApprovalModal" 
                      data-user-id="{{item.user_id}}"
                      data-file-id="{{item.submission.id}}"
                      data-username="{{item.username}}"
                      data-filename="{{item.submission.filename}}">
                审批
              </button>
            </block>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- 未提交用户列表 -->
  <view class="tab-content" wx:if="{{activeTab === 'pending'}}">
    <view class="search-box">
      <input type="text" class="search-input" placeholder="搜索用户名或公司名称..." bindinput="onSearchPending"/>
    </view>

    <view class="table-container">
      <view class="table-header">
        <view class="th">用户名</view>
        <view class="th">公司名称</view>
        <view class="th">联系方式</view>
      </view>

      <view class="no-data" wx:if="{{!filteredPendingUsers.length}}">
        <text>暂无未提交用户</text>
      </view>

      <block wx:else>
        <view class="table-row" wx:for="{{filteredPendingUsers}}" wx:key="user_id">
          <view class="td">{{item.username}}</view>
          <view class="td">{{item.company_name || '未设置'}}</view>
          <view class="td">{{item.contact_info || '未设置'}}</view>
        </view>
      </block>
    </view>
  </view>

  <!-- 提交分析 -->
  <view class="tab-content analytics-container" wx:if="{{activeTab === 'analytics'}}">
    <!-- 提交率卡片 -->
    <view class="analytics-card">
      <view class="card-title">提交概况</view>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{submissionRate}}%</text>
          <text class="stat-label">提交率</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{submittedCount}}</text>
          <text class="stat-label">已提交</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{pendingCount}}</text>
          <text class="stat-label">未提交</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{totalUsers}}</text>
          <text class="stat-label">总用户数</text>
        </view>
      </view>
    </view>

    <!-- 提交率饼图 -->
    <view class="analytics-card">
      <view class="card-title">提交率分析</view>
      <view class="pie-chart-container">
        <!-- 使用饼图组件 -->
        <pie-chart 
          percentage="{{submissionRate}}" 
          size="300" 
          primaryColor="#10b981" 
          secondaryColor="#f59e0b"
          submittedCount="{{submittedCount}}"
          pendingCount="{{pendingCount}}">
        </pie-chart>
      </view>
    </view>
    
    <!-- 审批状态分析 -->
    <view class="analytics-card">
      <view class="card-title">审批状态分析</view>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{approvalStats.pendingCount || 0}}</text>
          <text class="stat-label">待审批</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{approvalStats.approvedCount || 0}}</text>
          <text class="stat-label">已通过</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{approvalStats.rejectedCount || 0}}</text>
          <text class="stat-label">已拒绝</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 审批模态框 -->
  <view class="modal approval-modal" wx:if="{{showApprovalModal}}" catchtouchmove="preventTouchMove">
    <view class="modal-mask" bindtap="hideApprovalModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>审批文件</text>
        <text class="close" bindtap="hideApprovalModal">×</text>
      </view>
      
      <view class="modal-body">
        <view class="file-info">
          <view class="info-item">
            <text class="info-label">用户名：</text>
            <text class="info-value">{{currentApproval.username}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">文件名：</text>
            <text class="info-value">{{currentApproval.filename}}</text>
          </view>
        </view>
        
        <view class="approval-options">
          <view class="option-label">审批决定：</view>
          <view class="radio-group">
            <view class="radio {{approvalDecision === 'approved' ? 'selected' : ''}}" 
                  bindtap="selectApprovalDecision" 
                  data-decision="approved">
              <view class="radio-dot"></view>
              <text>通过</text>
            </view>
            <view class="radio {{approvalDecision === 'rejected' ? 'selected' : ''}}" 
                  bindtap="selectApprovalDecision" 
                  data-decision="rejected">
              <view class="radio-dot"></view>
              <text>拒绝</text>
            </view>
          </view>
        </view>
        
        <view class="comment-area">
          <view class="option-label">审批意见：</view>
          <textarea placeholder="请输入审批意见（可选）" 
                    bindinput="onApprovalCommentInput" 
                    value="{{approvalComment}}"></textarea>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideApprovalModal">取消</button>
        <button class="btn-submit" bindtap="submitApproval" disabled="{{!approvalDecision}}">提交</button>
      </view>
    </view>
  </view>
</view>