<!-- pages/admin/template/list.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="action-bar">
    <view class="search-box">
      <input type="text" class="search-input" placeholder="æœç´¢æ¨¡æ¿åç§°..." bindinput="onSearchInput"/>
      <button class="search-btn" bindtap="handleSearch">æœç´¢</button>
    </view>
    <view class="action-buttons">
      <button class="btn-batch-delete" bindtap="showBatchDeleteConfirm" wx:if="{{selectedTemplates.length > 0}}">æ‰¹é‡åˆ é™¤({{selectedTemplates.length}})</button>
      <button class="btn-upload" bindtap="showUploadModal">ä¸Šä¼ æ–°æ¨¡æ¿</button>
    </view>
  </view>

  <!-- æ¨¡æ¿åˆ—è¡¨è¡¨æ ¼ -->
  <view class="table-container">
    <!-- è¡¨å¤´ -->
    <view class="table-header">
      <view class="th th-checkbox">
        <checkbox checked="{{selectAll}}" bindtap="toggleSelectAll" />
      </view>
      <view class="th th-info">æ¨¡æ¿ä¿¡æ¯</view>
      <view class="th th-date">ä¸Šä¼ æ—¥æœŸ</view>
      <view class="th th-actions">æ“ä½œ</view>
    </view>

    <!-- æ— æ•°æ®æç¤º -->
    <view class="no-data" wx:if="{{!templates.length}}">
      <text>æš‚æ— æ¨¡æ¿æ•°æ®</text>
    </view>

    <!-- è¡¨æ ¼å†…å®¹ -->
    <block wx:else>
      <view class="table-row" wx:for="{{filteredTemplates}}" wx:key="id" bindtap="viewSubmissionDetails" data-id="{{item.id}}" data-name="{{item.name}}">
        <view class="td td-checkbox" catchtap="stopPropagation">
          <checkbox checked="{{selectedIds[item.id]}}" catchtap="toggleSelect" data-id="{{item.id}}" />
        </view>
        <view class="td td-info">
          <view class="template-name">{{item.name}}</view>
          <view class="template-desc">{{item.description || 'æ— æè¿°'}}</view>
          <view class="template-status">
            <text class="status-text">æäº¤æƒ…å†µ: {{item.submitted_count || 0}}/{{item.total_users || 0}}</text>
            <progress class="status-progress" percent="{{(item.submitted_count / item.total_users) * 100 || 0}}" stroke-width="4" color="#10b981" active />
          </view>
        </view>
        <view class="td td-date">
          <block wx:if="{{item.upload_date}}">
            <text>{{item.upload_date.includes(' ') ? item.upload_date.split(' ')[0] : item.upload_date}}</text>
            <text wx:if="{{item.upload_date.includes(' ')}}">{{item.upload_date.split(' ')[1]}}</text>
          </block>
          <text wx:else>æš‚æ— æ—¥æœŸ</text>
        </view>
        <view class="td td-actions" catchtap="stopPropagation">
          <button class="btn btn-download" catchtap="downloadTemplate" data-id="{{item.id}}" data-name="{{item.name}}">ä¸‹è½½</button>
          <button class="btn btn-delete" catchtap="deleteTemplate" data-id="{{item.id}}" data-name="{{item.name}}">åˆ é™¤</button>
        </view>
      </view>
    </block>
  </view>

  <!-- åŠ è½½æ›´å¤šæç¤º -->
  <view class="load-more" wx:if="{{templates.length > 0 && hasMoreData}}">
    <text wx:if="{{isLoading}}">æ­£åœ¨åŠ è½½...</text>
    <text wx:else bindtap="loadMoreData">åŠ è½½æ›´å¤š</text>
  </view>

  <!-- ä¸Šä¼ æ¨¡æ¿æ¨¡æ€æ¡† - ä¼˜åŒ–ç‰ˆ -->
  <view class="modal" wx:if="{{showUpload}}" catchtouchmove="preventTouchMove">
    <view class="modal-mask" bindtap="hideUploadModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ä¸Šä¼ æ–°æ¨¡æ¿</text>
        <text class="close" bindtap="hideUploadModal">Ã—</text>
      </view>
      <form bindsubmit="handleUpload">
        <view class="form-body">
          <view class="form-item">
            <text class="label required">æ¨¡æ¿åç§°</text>
            <input class="input" name="name" placeholder="è¯·è¾“å…¥æ¨¡æ¿åç§°" />
          </view>
          
          <view class="form-item">
            <text class="label">æ¨¡æ¿æè¿°</text>
            <textarea class="textarea" name="description" placeholder="è¯·ç®€è¦æè¿°æ­¤æ¨¡æ¿çš„ç”¨é€”æˆ–æ³¨æ„äº‹é¡¹" />
          </view>
          
          <view class="form-item">
            <text class="label required">é€‰æ‹©æ–‡ä»¶</text>
            <view class="file-upload-area">
              <view class="file-box {{chosenFile ? 'has-file' : ''}}">
                <view class="upload-icon" wx:if="{{!chosenFile}}">
                  <view class="icon-plus">+</view>
                  <view class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</view>
                </view>
                <view class="file-info" wx:if="{{chosenFile}}">
                  <view class="file-icon">ğŸ“„</view>
                  <view class="file-details">
                    <text class="file-name">{{chosenFile.name}}</text>
                  </view>
                  <view class="file-action">
                    <text class="file-change" catchtap="chooseFile">æ›´æ”¹</text>
                  </view>
                </view>
              </view>
              <button class="btn-choose" bindtap="chooseFile" wx:if="{{!chosenFile}}">é€‰æ‹©æ–‡ä»¶</button>
            </view>
          </view>
          
          <view class="upload-progress-container" wx:if="{{uploadProgress > 0}}">
            <text class="progress-text">ä¸Šä¼ ä¸­ {{uploadProgress}}%</text>
            <progress class="upload-progress" percent="{{uploadProgress}}" stroke-width="4" activeColor="#10b981" backgroundColor="#e5e7eb" active active-mode="forwards" />
          </view>
        </view>

        <view class="form-actions">
          <button class="btn-cancel" bindtap="hideUploadModal">å–æ¶ˆ</button>
          <button class="btn-submit" form-type="submit" disabled="{{!chosenFile}}">
            {{uploadProgress > 0 ? 'ä¸Šä¼ ä¸­...' : 'ä¸Šä¼ æ¨¡æ¿'}}
          </button>
        </view>
      </form>
    </view>
  </view>

  <!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
  <view class="modal" wx:if="{{showBatchDelete}}" catchtouchmove="preventTouchMove">
    <view class="modal-mask" bindtap="hideBatchDeleteModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç¡®è®¤æ‰¹é‡åˆ é™¤</text>
        <text class="close" bindtap="hideBatchDeleteModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="warning-message">
          <view class="warning-icon">âš ï¸</view>
          <text>æ‚¨å³å°†åˆ é™¤ {{selectedTemplates.length}} ä¸ªæ¨¡æ¿ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</text>
        </view>
        <view class="template-list">
          <view class="template-item" wx:for="{{selectedTemplates}}" wx:key="id">
            <text>â€¢ {{item.name}}</text>
          </view>
        </view>
        <view class="warning-text">æ‰€æœ‰å…³è”çš„æäº¤æ•°æ®ä¹Ÿå°†è¢«åˆ é™¤ã€‚</view>
      </view>
      <view class="form-actions">
        <button class="btn-cancel" bindtap="hideBatchDeleteModal">å–æ¶ˆ</button>
        <button class="btn-delete-confirm" bindtap="executeBatchDelete" disabled="{{isDeleting}}">
          {{isDeleting ? 'åˆ é™¤ä¸­...' : 'ç¡®è®¤åˆ é™¤'}}
        </button>
      </view>
    </view>
  </view>
</view>