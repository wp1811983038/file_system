<view class="container">
  <!-- 搜索区域 -->
  <view class="search-box">
    <input type="text" 
           class="search-input" 
           placeholder="搜索文件名..." 
           bindinput="onSearch"/>
  </view>

  <!-- 文件列表 -->
  <view class="table-container">
    <!-- 表头 -->
    <view class="table-header">
      <view class="th">序号</view>
      <view class="th">文件名</view>
      <view class="th">描述</view>
      <view class="th">状态</view>
      <view class="th">操作</view>
    </view>

    <!-- 表格内容 -->
    <block wx:if="{{!templates.length}}">
      <view class="no-data">暂无数据</view>
    </block>
    <block wx:else>
      <view class="table-row" wx:for="{{templates}}" wx:key="id">
        <view class="td">{{index + 1}}</view>
        <view class="td">{{item.name || '未命名'}}</view>
        <view class="td clickable" bindtap="showDescription" data-description="{{item.description || '无'}}">
          {{item.description || '无'}}
        </view>
        <view class="td">
          <view class="status-badge {{item.status ? 'status-'+item.status : 'status-draft'}}">
  {{item.status === 'draft' || !item.status ? '草稿' : 
    item.status === 'submitted' ? '已提交' : 
    item.status === 'under_review' ? '审核中' : 
    item.status === 'approved' ? '已通过' : 
    item.status === 'rejected' ? '已拒绝' : '草稿'}}
</view>
        </view>
        <view class="td actions">
          <button class="btn download-btn" bindtap="downloadTemplate" 
                  data-id="{{item.id}}" 
                  data-name="{{item.name}}">
            下载
          </button>
          
          <!-- 根据状态动态显示不同按钮 -->
          <block wx:if="{{item.status === 'draft' || !item.status}}">
            <button class="btn primary-btn" 
                    bindtap="openUploadModal" 
                    data-template-id="{{item.id}}" 
                    data-is-resubmit="{{false}}">
              上传
            </button>
          </block>
          <block wx:elif="{{item.status === 'submitted' || item.status === 'under_review'}}">
            <button class="btn info-btn" bindtap="viewApprovalProgress" data-file-id="{{item.submission_id}}">
              查看进度
            </button>
          </block>
          <block wx:elif="{{item.status === 'rejected'}}">
            <button class="btn warning-btn" bindtap="openUploadModal" data-template-id="{{item.id}}" data-is-resubmit="{{true}}">
              重新提交
            </button>
          </block>
          <block wx:elif="{{item.status === 'approved'}}">
            <button class="btn success-btn" bindtap="viewFile" data-file-id="{{item.submission_id}}">
              查看文件
            </button>
          </block>
        </view>
      </view>
    </block>
  </view>
</view>

<!-- 上传文件弹窗 -->
<view class="modal" wx:if="{{showUploadModal}}" catchtouchmove="preventTouchMove">
  <view class="modal-content">
    <view class="modal-title">{{isResubmit ? '重新提交文件' : '提交文件'}}</view>
    <form bindsubmit="submitFile">
      <view class="form-group">
        <button class="btn primary-btn" bindtap="chooseFile">选择文件</button>
        <view class="selected-file" wx:if="{{selectedFile}}">
          已选择：{{selectedFile.name}}
        </view>
      </view>
      <view class="modal-btns">
        <button class="btn cancel-btn" bindtap="closeUploadModal">取消</button>
        <button class="btn primary-btn" form-type="submit" disabled="{{!selectedFile}}">确定</button>
      </view>
    </form>
  </view>
</view>

<!-- 描述内容查看弹窗 -->
<view class="modal description-modal" wx:if="{{showDescriptionModal}}" catchtouchmove="preventTouchMove" bindtap="closeDescriptionModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-title">详细描述</view>
    <view class="description-content">{{currentDescription}}</view>
    <view class="modal-btns">
      <button class="btn primary-btn" bindtap="closeDescriptionModal">关闭</button>
    </view>
  </view>
</view>

<!-- 审批进度查看弹窗 -->
<view class="modal approval-modal" wx:if="{{showApprovalModal}}" catchtouchmove="preventTouchMove" bindtap="closeApprovalModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-title">审批进度</view>
    <view class="approval-status">
      <view class="status-info">
        <text class="status-label">当前状态：</text>
        <view class="status-badge {{currentApproval.status === 'submitted' ? 'status-submitted' : 
                                   currentApproval.status === 'under_review' ? 'status-under-review' : 
                                   currentApproval.status === 'approved' ? 'status-approved' : 
                                   currentApproval.status === 'rejected' ? 'status-rejected' : 'status-draft'}}">
          {{currentApproval.status === 'submitted' ? '已提交' : 
            currentApproval.status === 'under_review' ? '审核中' : 
            currentApproval.status === 'approved' ? '已通过' : 
            currentApproval.status === 'rejected' ? '已拒绝' : '草稿'}}
        </view>
      </view>
    </view>
    
    <view class="approval-steps">
      <view class="approval-step {{step.status === 'pending' ? '' : step.status === 'approved' ? 'approved' : 'rejected'}}" 
            wx:for="{{currentApproval.steps}}" 
            wx:for-item="step" 
            wx:key="index">
        <view class="step-number">{{index + 1}}</view>
        <view class="step-info">
          <view class="step-title">
            <text>{{step.approver_name || '审批人'}}</text>
            <text class="step-date" wx:if="{{step.approval_date}}">{{step.approval_date}}</text>
          </view>
          <view class="step-comment" wx:if="{{step.comments}}">{{step.comments}}</view>
        </view>
        <view class="step-status">
          <text class="status-text {{step.status}}">
            {{step.status === 'pending' ? '待审批' : 
              step.status === 'approved' ? '已通过' : '已拒绝'}}
          </text>
        </view>
      </view>
    </view>
    
    <view class="modal-btns">
      <button class="btn primary-btn" bindtap="closeApprovalModal">关闭</button>
    </view>
  </view>
</view>

<!-- 文件查看弹窗 -->
<view class="modal file-view-modal" wx:if="{{showFileViewModal}}" catchtouchmove="preventTouchMove" bindtap="closeFileViewModal">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-title">查看文件</view>
    <view class="file-view-options">
      <button class="btn download-btn" bindtap="downloadSubmission" data-file-id="{{currentFileId}}">
        下载文件
      </button>
      <button class="btn preview-btn" bindtap="previewSubmission" data-file-id="{{currentFileId}}">
        预览文件
      </button>
    </view>
    <view class="modal-btns">
      <button class="btn primary-btn" bindtap="closeFileViewModal">关闭</button>
    </view>
  </view>
</view>